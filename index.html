<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–®–∫–æ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî Online</title>
<style>
  :root{
    --bg:#0b1220; --muted:#7e8aa3; --text:#e8eefc; --gold:#ffd54a;

    /* –ü—Ä–æ–∂–µ–∫—Ç–æ—Ä */
    --disc: 64px;        /* –¥–∏–∞–º–µ—Ç—Ä –∫–æ–Ω–µ—á–Ω–æ–≥–æ –¥–∏—Å–∫–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ) */
    --thin: 2px;         /* —Ç–æ–ª—â–∏–Ω–∞ –ª—É—á–∞ —É –∏—Å—Ç–æ—á–Ω–∏–∫–∞ */
    --gap: 6px;          /* –º–∏–∫—Ä–æ–∑–∞–∑–æ—Ä, —á—Ç–æ–±—ã –ª—É—á –≤—Ö–æ–¥–∏–ª –≤ –¥–∏—Å–∫ –∫—Ä–∞—Å–∏–≤–æ */
    --sweep: 8s;         /* —Å–∫–æ—Ä–æ—Å—Ç—å –±–µ–≥—É—â–µ–π –ø–æ–ª–æ—Å—ã */
    --city-h:160px;      /* –≤—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞ ¬´–≥–æ—Ä–æ–¥–∞¬ª */
    --src-perc:12;       /* X-–ø–æ–∑–∏—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∫–∞–∫ % —à–∏—Ä–∏–Ω—ã –≤—å—é–ø–æ—Ä—Ç–∞ (–±–∞—à–Ω—è) */
    --src-y-offset:24px; /* –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—ã—à–µ –∫—Ä—ã—à–∏ –≥–æ—Ä–æ–¥–∞ —Å—Ç–∞–≤–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫ */
  }

  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 800px at 20% -10%,#162554 0%,#0b1220 60%) fixed;
    overflow-x:hidden;
  }

  /* –ì–æ—Ä–æ–¥ —Å–Ω–∏–∑—É */
  .city{
    position:fixed; left:0; right:0; bottom:0; height:var(--city-h); z-index:0;
    background:
      linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0)) 0 0/100% 100%,
      url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="160" viewBox="0 0 1600 160">\
<rect width="1600" height="160" fill=\"%230a1326\"/>\
<path d=\"M0,140 h80 v-40 h40 v-60 h60 v60 h40 v-30 h40 v30 h50 v-70 h70 v70 h40 v-40 h50 v40 h60 v-90 h60 v90 h60 v-50 h40 v50 h70 v-30 h30 v30 h70 v-110 h50 v110 h80 v20 H0z\" fill=\"%2312213f\"/>\
<path d=\"M0,150 h90 v-30 h30 v-60 h40 v60 h50 v-40 h40 v40 h50 v-70 h60 v70 h40 v-30 h60 –≤30 h70 v-100 h40 v100 h50 v-50 h60 v50 h90 v10 H0z\" fill=\"%23152a52\"/>\
</svg>') repeat-x bottom left / cover;
    opacity:.85; pointer-events:none;
  }
  /* –ó–≤–µ–∑–¥–æ–ø–∞–¥ —Ç–æ–ª—å–∫–æ –≤ –∑–æ–Ω–µ –≥–æ—Ä–æ–¥–∞ */
  .starfall{ position:absolute; top:0; left:0; right:0; height:100%; z-index:1; overflow:hidden; }
  .meteor{
    position:absolute; width:2px; height:2px;
    background:linear-gradient(45deg, rgba(255,255,255,0.9), rgba(255,255,255,0.2));
    border-radius:50%; box-shadow:0 0 6px 1px rgba(255,255,255,0.4);
    animation:meteorFall 4s linear infinite;
  }
  .meteor:nth-child(1){ left:20%; animation-delay:0s }
  .meteor:nth-child(2){ left:50%; animation-delay:1.5s }
  .meteor:nth-child(3){ left:80%; animation-delay:3s }
  @keyframes meteorFall{
    0%{ transform:translate(0,-100%) rotate(45deg); opacity:1 }
    100%{ transform:translate(-100px,var(--city-h)) rotate(45deg); opacity:0 }
  }

  .wrap{max-width:800px;margin:0 auto;padding:20px; position:relative; z-index:2}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .title{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px; font-size:clamp(22px,3vw,36px); }
  .subtitle{display:none}
  .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:16px}
  .tile{
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
    border:1px solid rgba(255,255,255,.06);
    border-radius:14px;padding:12px 14px;box-shadow:0 4px 12px rgba(0,0,0,.25)
  }
  .left{display:flex;align-items:center;gap:12px;min-width:0}
  .rank{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;font-weight:800;background:#0f1730;border:1px solid rgba(255,255,255,.08)}
  .name{font-weight:700;letter-spacing:.3px;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .class{font-size:14px;color:var(--muted)}
  .right{display:flex;align-items:center;gap:12px}
  .score{font-weight:800;min-width:48px;text-align:right;font-size:18px}
  .medal{font-size:24px}
  .footer{margin-top:12px;display:flex;justify-content:space-between;color:#7e8aa3;font-size:12px;align-items:center;gap:8px;flex-wrap:wrap}

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ù–æ–≤—ã–π –ª—É—á –∏–∑ –≥–æ—Ä–æ–¥–∞ (—Å–Ω–∏–∑—É —Å–ª–µ–≤–∞ –∫ –¥–∏—Å–∫—É). –ù–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ. ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #city-beam{
    position:fixed;
    left:0; bottom:0;
    width: var(--disc);                     /* –¥–∞–ª—å–Ω–∏–π –∫–æ–Ω–µ—Ü = —à–∏—Ä–∏–Ω–∞ –¥–∏—Å–∫–∞ */
    height: 200px;                          /* —Ä–µ–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É —Å—Ç–∞–≤–∏—Ç JS */
    transform-origin: bottom center;
    z-index:0;                              /* –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º (.wrap z=2) */
    pointer-events:none;
    display:block;
  }
  [data-beam="off"] #city-beam{ display:none; }

  /* –ì–µ–æ–º–µ—Ç—Ä–∏—è –ª—É—á–∞ ‚Äî —Ç—Ä–∞–ø–µ—Ü–∏—è */
  #city-beam .beam-shape,
  #city-beam .beam-sweep,
  #city-beam .beam-dust{
    position:absolute; inset:0;
    clip-path: polygon(
      calc(50% - var(--thin)) 100%,
      calc(50% + var(--thin)) 100%,
      100%                      0%,
      0%                        0%
    );
  }
  #city-beam .beam-shape{
    background: linear-gradient(0deg,
      rgba(255,238,170,0.00) 0%,
      rgba(255,238,170,0.12) 30%,
      rgba(255,238,170,0.32) 100%
    );
    filter: blur(.9px);
  }
  #city-beam .beam-sweep{
    background: linear-gradient(0deg,
      transparent 0%,
      transparent 30%,
      rgba(255,245,180,.45) 40%,
      rgba(255,245,180,.9)  45%,
      rgba(255,245,180,.45) 50%,
      transparent 60%,
      transparent 100%
    );
    background-size:100% 300%;
    mix-blend-mode:screen; opacity:.65; filter:blur(1px);
    animation: sweepOneWay var(--sweep) linear infinite;
  }
  @keyframes sweepOneWay{
    0%{   background-position:0 300% }
    100%{ background-position:0 -100% }
  }
  #city-beam .beam-dust{
    background:
      radial-gradient(1.8px 1.8px at 12% 78%, rgba(255,255,210,.25) 0, rgba(255,255,210,0) 60%),
      radial-gradient(1.8px 1.8px at 32% 60%, rgba(255,255,210,.18) 0, rgba(255,255,210,0) 60%),
      radial-gradient(1.8px 1.8px at 56% 70%, rgba(255,255,210,.22) 0, rgba(255,255,210,0) 60%),
      radial-gradient(1.8px 1.8px at 76% 50%, rgba(255,255,210,.16) 0, rgba(255,255,210,0) 60%);
    filter: blur(.25px); opacity:.55;
    animation: dustDrift 9s linear infinite;
  }
  @keyframes dustDrift{
    0%{   transform:translateX(-1%) translateY( 6%) }
    100%{ transform:translateX( 1%) translateY(-6%) }
  }

  /* ¬´–î—ã—Ö–∞–Ω–∏–µ¬ª —è—Ä–∫–æ—Å—Ç–∏ —É –Ω–æ—Å–∏–∫–∞ –ø—Ä–æ–∂–µ–∫—Ç–æ—Ä–∞ (—É –æ—Å–Ω–æ–≤–∞–Ω–∏—è) */
  #city-beam::after{
    content:"";
    position:absolute; left:50%; bottom:-2px; transform:translateX(-50%);
    width: 42px; height: 42px; border-radius:50%;
    background: radial-gradient(circle, rgba(255,246,200,.9) 0%, rgba(255,240,160,.4) 45%, rgba(255,240,160,0) 70%);
    filter: blur(2px);
    animation: breath 3.2s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes breath{
    0%,100%{ transform:translateX(-50%) scale(1);    opacity:.85 }
    50%    { transform:translateX(-50%) scale(1.12); opacity:1   }
  }

  /* –î–∏—Å–∫/–∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å—Ç–∞—Ä—ã–π –ª—É—á —Å–∫—Ä—ã—Ç */
  .batsignal{
    position: fixed;
    left: 50px; bottom: 80px;
    width: calc(var(--disc) + 16px);
    height: calc(var(--city-h) + var(--disc) + 16px);
    z-index: 1; /* –ø–æ–≤–µ—Ä—Ö –≥–æ—Ä–æ–¥–∞ –∏ –≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ –ª—É—á–∞, –Ω–æ –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º */
    overflow: visible; opacity:1;
  }
  .batsignal .beam{ display:none; } /* –æ—Ç–∫–ª—é—á—ë–Ω */

  .batsignal .target{
    position:absolute; left:8px; top:0;
    width: var(--disc); height: var(--disc);
  }
  .batsignal .target::before{
    content:""; position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(circle at 35% 35%, #fff9c9 0%, #ffe58b 50%, #ffd55a 100%);
    box-shadow: 0 0 12px 4px rgba(255, 240, 150, 0.6);
    animation: spotPulse 2.8s ease-in-out infinite;
  }
  @keyframes spotPulse{ 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.1)} }
  .batsignal .target-img{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:contain; filter: drop-shadow(0 0 2px rgba(0,0,0,.35));
    opacity:1;
  }

  /* –¢—É–º–±–ª–µ—Ä –ª—É—á–∞ */
  .beam-toggle{
    display:flex; align-items:center; gap:8px;
    padding:6px 10px; border:1px solid rgba(255,255,255,.12);
    border-radius:10px; background:rgba(255,255,255,.04);
    user-select:none; cursor:pointer;
  }
  .beam-toggle input{ accent-color:#ffd54a; width:18px; height:18px; }
</style>
</head>
<body data-beam="on">
  <div class="wrap">
    <header>
      <div class="title">–®–∫–æ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî Online</div>
      <div class="subtitle" id="status"></div>
    </header>

    <div id="grid" class="grid"></div>

    <div class="footer">
      <span id="updated"></span>
      <span>–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º (F11) –Ω–∞ –¢–í</span>

      <!-- –¢—É–º–±–ª–µ—Ä –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ –ª—É—á–∞ -->
      <label class="beam-toggle" title="–ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ L">
        <input id="beamSwitch" type="checkbox" checked>
        –õ—É—á –∏–∑ –ì–æ—Ç—ç–º–∞
      </label>
    </div>
  </div>

  <div class="city" aria-hidden="true">
    <div class="starfall">
      <div class="meteor"></div>
      <div class="meteor"></div>
      <div class="meteor"></div>
    </div>
  </div>

  <!-- –õ—É—á –∏–∑ –≥–æ—Ä–æ–¥–∞ -->
  <div id="city-beam" aria-hidden="true">
    <div class="beam-shape"></div>
    <div class="beam-sweep"></div>
    <div class="beam-dust"></div>
  </div>

  <!-- –î–∏—Å–∫/–ª–æ–≥–æ—Ç–∏–ø (–ª—É—á –≤–Ω—É—Ç—Ä–∏ –æ—Ç–∫–ª—é—á—ë–Ω) -->
  <div id="batsignal" class="batsignal" aria-hidden="true">
    <div class="beam"></div>
    <div class="target">
      <img class="target-img" src="bat-signal.png" alt="bat-signal">
    </div>
  </div>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-yAedPlzSiucopAyXDGUCa4NC8sSVW1e6yxsFXksSIgxTkJhkONG6daXkg2Y8cGwaqsrffbt22_Py/pub?gid=1022445244&single=true&output=csv";
  const REFRESH_MS = 11000;

  const gridEl = document.getElementById('grid');
  const updatedEl = document.getElementById('updated');
  const batSignalEl = document.getElementById('batsignal');
  const cityBeamEl = document.getElementById('city-beam');
  const beamSwitch = document.getElementById('beamSwitch');

  function medalType(str){
    const s=(str||'').toLowerCase();
    if (s.includes('–∑–æ–ª')||s.includes('gold')) return 'gold';
    if (s.includes('—Å–µ—Ä')||s.includes('silver')) return 'silver';
    if (s.includes('–±—Ä–æ–Ω')||s.includes('bronze')) return 'bronze';
    return '';
  }
  const medalOrder={gold:0,silver:1,bronze:2,"":3};
  const medalEmoji=t=>t==='gold'?'ü•á':t==='silver'?'ü•à':t==='bronze'?'ü•â':'';

  async function fetchCSV(){
    try{
      const res = await fetch(CSV_URL + '&_=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      const parsed = Papa.parse(text, { skipEmptyLines: "greedy" });
      render(parsed.data);
      updatedEl.textContent = '–í—Ä–µ–º—è: ' + new Date().toLocaleTimeString();
    }catch(e){ console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV:', e); }
  }

  function render(rows){
    if(!rows || rows.length===0){ gridEl.innerHTML=''; return; }
    const header = rows[0].map(h => (h||'').toString().trim().toLowerCase());
    const hasHdr = header.some(h => h.includes('—Ñ–∏–æ')||h.includes('name')||h.includes('–∏—Ç–æ–≥–æ')||h.includes('score')||h.includes('–º–µ–¥–∞–ª')||h.includes('medal')||h.includes('–∫–ª–∞—Å—Å')||h.includes('class'));
    const body = rows.slice(hasHdr?1:0);
    let idxName  = hasHdr ? header.findIndex(h=>h.includes('—Ñ–∏–æ')||h.includes('name')) : 0;
    let idxScore = hasHdr ? header.findIndex(h=>h.includes('–∏—Ç–æ–≥–æ')||h.includes('score')) : 1;
    let idxMedal = hasHdr ? header.findIndex(h=>h.includes('–º–µ–¥–∞–ª')||h.includes('medal')) : 2;
    let idxClass = hasHdr ? header.findIndex(h=>h.includes('–∫–ª–∞—Å—Å')||h.includes('class')) : 3;
    if(idxName<0)  idxName=0;
    if(idxScore<0) idxScore=1;
    if(idxMedal<0) idxMedal=2;
    if(idxClass<0) idxClass=3;

    const data = body.map(r=>{
      const name  = (r[idxName]  ?? '').toString().trim();
      const score = parseFloat((r[idxScore] ?? '0').toString().replace(',','.')) || 0;
      const medal = (r[idxMedal] ?? '').toString().trim();
      const klass = (r[idxClass] ?? '').toString().trim();
      return { name, score: Math.round(score), medal, klass };
    }).filter(r=>r.name);

    data.sort((a,b)=>{
      const ma=medalType(a.medal), mb=medalType(b.medal);
      const byM=(medalOrder[ma]??3)-(medalOrder[mb]??3); if(byM) return byM;
      const byS=(b.score||0)-(a.score||0); if(byS) return byS;
      return a.name.localeCompare(b.name,'ru');
    });

    gridEl.innerHTML='';
    data.forEach((row,i)=>{
      const t=medalType(row.medal), e=medalEmoji(t);
      const el=document.createElement('div'); el.className='tile';
      el.innerHTML = `
        <div class="left">
          <div class="rank">${i+1}</div>
          <div>
            <div class="name">${e?e+' ':''}${row.name}</div>
            ${row.klass ? `<div class="class">–ö–ª–∞—Å—Å: ${row.klass}</div>` : ""}
          </div>
        </div>
        <div class="right">
          ${e?`<div class="medal">${e}</div>`:""}
          <div class="score">${row.score}</div>
        </div>`;
      gridEl.appendChild(el);
    });

    updateCityBeam();
  }

  // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ª—É—á–∞ –∏–∑ –±–∞—à–Ω–∏ –∫ –¥–∏—Å–∫—É
  function updateCityBeam(){
    const discEl = batSignalEl.querySelector('.target');
    if(!discEl) return;

    const discRect = discEl.getBoundingClientRect();
    const discCx = discRect.left + discRect.width/2;
    const discCy = discRect.top  + discRect.height/2;

    const cityH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--city-h')) || 160;

    // –ò—Å—Ç–æ—á–Ω–∏–∫: X –∫–∞–∫ % —à–∏—Ä–∏–Ω—ã –≤—å—é–ø–æ—Ä—Ç–∞ (–ø—Ä–∏–≤—è–∑–∞–Ω –∫ –±–∞—à–Ω–µ —Å–∏–ª—É—ç—Ç–∞),
    // Y ‚Äî —á—É—Ç—å –≤—ã—à–µ –ª–∏–Ω–∏–∏ –≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞.
    const srcPerc = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--src-perc')) || 12;
    const srcX = Math.round(window.innerWidth * (srcPerc/100));
    const srcY = window.innerHeight - cityH + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--src-y-offset')) || 24;

    const dx = discCx - srcX;
    const dy = discCy - srcY;
    const distance = Math.hypot(dx, dy);

    const angleRad = Math.atan2(-dy, dx); // –∏–Ω–≤–µ—Ä—Å–∏—è Y
    const angleDeg = (90 - angleRad * 180/Math.PI);

    cityBeamEl.style.height = `${Math.max(40, distance - parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')))}px`;
    cityBeamEl.style.transform = `translate(${srcX}px, ${srcY}px) rotate(${angleDeg}deg)`;
  }

  // –¢—É–º–±–ª–µ—Ä + –≥–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ L
  function setBeam(on){
    document.body.setAttribute('data-beam', on ? 'on' : 'off');
    beamSwitch.checked = on;
  }
  beamSwitch.addEventListener('change', e=> setBeam(e.target.checked));
  window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='l'){
      const on = document.body.getAttribute('data-beam') !== 'on';
      setBeam(on);
    }
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  fetchCSV();
  setInterval(fetchCSV, REFRESH_MS);

  const ro = new ResizeObserver(()=>updateCityBeam());
  ro.observe(document.body);
  window.addEventListener('orientationchange', updateCityBeam);
  window.addEventListener('load', ()=>{ updateCityBeam(); setBeam(true); });
  </script>
</body>
</html>
