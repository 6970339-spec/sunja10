<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–®–∫–æ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî Online</title>
<style>
  :root{
    --bg:#0b1220; --muted:#7e8aa3; --text:#e8eefc;
    /* –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Ä–∞–∑–º–µ—Ä—ã/–ø–æ–∑–∏—Ü–∏–∏ –ª–æ–≥–æ—Ç–∏–ø–æ–≤ */
    --bat-size: 520px; --bat-top:-10px; --bat-right:-40px;
    --signal-size: 260px; --signal-top:22px; --signal-right:18px;
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 800px at 20% -10%,#162554 0%,#0b1220 60%) fixed;
    overflow-x:hidden;
  }

  /* –≥–æ—Ä–æ–¥ –≤–Ω–∏–∑—É */
  .city{
    position:fixed; left:0; right:0; bottom:0; height:160px; z-index:0;
    background:
      linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0)),
      url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="1600" height="160" viewBox="0 0 1600 160">\
        <rect width="1600" height="160" fill="%230a1326"/>\
        <path d="M0,140 h80 v-40 h40 v-60 h60 v60 h40 v-30 h40 v30 h50 v-70 h70 v70 h40 v-40 h50 v40 h60 v-90 h60 v90 h60 v-50 h40 v50 h70 v-30 h30 v30 h70 v-110 h50 v110 h80 v20 H0z" fill="%2312213f"/>\
        <path d="M0,150 h90 v-30 h30 v-60 h40 v60 h50 v-40 h40 v40 h50 v-70 h60 v70 h40 v-30 h60 v30 h70 v-100 h40 v100 h50 v-50 h60 v50 h90 v10 H0z" fill="%23152a52"/>\
      </svg>') repeat-x bottom left / cover;
    opacity:.85; pointer-events:none;
  }

  /* –±–æ–ª—å—à–æ–π –∑–∞–¥–Ω–∏–π –ª–æ–≥–æ—Ç–∏–ø */
  .bat-bg{
    position:fixed; z-index:1;
    top:var(--bat-top); right:var(--bat-right);
    width:var(--bat-size); opacity:.92;
    filter: drop-shadow(0 0 22px rgba(255,240,140,.25))
            drop-shadow(0 18px 35px rgba(0,0,0,.35));
    pointer-events:none;
  }
  .bat-bg img{ width:100%; height:auto; display:block }

  /* –º–∞–ª–µ–Ω—å–∫–∏–π ¬´—Å–∏–≥–Ω–∞–ª¬ª (–ø–æ–∫–∞–∂–µ–º –ø—Ä–∏ –∑–æ–ª–æ—Ç–µ –Ω–∞ 1 –º–µ—Å—Ç–µ) */
  .batsignal{
    position:fixed; z-index:2;
    top:var(--signal-top); right:var(--signal-right);
    width:var(--signal-size); opacity:0; transform:translateY(-6px);
    transition:.45s ease; pointer-events:none;
    filter: drop-shadow(0 8px 22px rgba(255,240,150,.35)) brightness(1.05);
  }
  .batsignal.show{ opacity:.95; transform:translateY(0) }
  .batsignal img{ width:100%; height:auto; display:block; border-radius:6px }

  .wrap{max-width:980px;margin:0 auto;padding:20px; position:relative; z-index:3}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .title{font-weight:900;letter-spacing:.5px;font-size:clamp(28px,4vw,56px);display:flex;align-items:center;gap:14px}
  .title img{height:44px;width:44px;object-fit:contain;filter: drop-shadow(0 0 6px rgba(255,255,180,.22))}
  .subtitle{color:var(--muted);font-size:14px}

  .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:18px}
  .tile{
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
    border:1px solid rgba(255,255,255,.06);
    border-radius:18px;padding:14px 16px;box-shadow:0 6px 20px rgba(0,0,0,.25)
  }
  .left{display:flex;align-items:center;gap:14px;min-width:0}
  .rank{width:48px;height:48px;border-radius:12px;display:grid;place-items:center;
        font-weight:800;background:#0f1730;border:1px solid rgba(255,255,255,.08);font-size:20px}
  .name{font-weight:800;letter-spacing:.3px;font-size:26px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .class{font-size:16px;color:var(--muted);margin-top:4px}
  .right{display:flex;align-items:center;gap:14px}
  .score{font-weight:900;min-width:54px;text-align:right;font-size:26px}
  .medal{font-size:26px}
  .footer{margin-top:14px;display:flex;justify-content:space-between;color:#7e8aa3;font-size:14px}
  .blink{animation:blink 1.2s linear infinite}@keyframes blink{50%{opacity:.35}}
</style>
</head>
<body>

  <!-- –∑–∞–¥–Ω–∏–π –ª–æ–≥–æ—Ç–∏–ø -->
  <div class="bat-bg"><img id="bat-bg-img" alt="Bat logo"></div>
  <!-- –º–∞–ª–µ–Ω—å–∫–∏–π —Å–∏–≥–Ω–∞–ª -->
  <div id="batsignal" class="batsignal"><img id="batsignal-img" alt="Bat-Signal"></div>

  <div class="wrap">
    <header>
      <div class="title">
        <img src="https://upload.wikimedia.org/wikipedia/commons/2/20/Batman_logo.svg" alt="Batman">
        –®–∫–æ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî Online
      </div>
      <div class="subtitle" id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    </header>

    <div id="grid" class="grid"></div>

    <div class="footer">
      <span id="updated"></span>
      <span>–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º (F11) –Ω–∞ –¢–í</span>
    </div>
  </div>

  <div class="city" aria-hidden="true"></div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  /* 1) –£–ö–ê–ñ–ò –ò–ú–Ø –¢–í–û–ï–ì–û –§–ê–ô–õ–ê (–∫–æ—Ç–æ—Ä—ã–π –∑–∞–≥—Ä—É–∑–∏–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π) */
  const BAT_IMG_LOCAL = "bat.png";   // ‚Üê –ü–µ—Ä–µ–∏–º–µ–Ω—É–π –ø–æ–¥ —Å–≤–æ–π —Ñ–∞–π–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä "logo.png"

  /* 2) –ù–∞–¥—ë–∂–Ω—ã–π –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (–µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –Ω–µ –Ω–∞–π–¥—ë—Ç—Å—è) */
  const BAT_IMG_FALLBACK = "https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Batman_Symbol.svg/512px-Batman_Symbol.svg.png";

  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-yAedPlzSiucopAyXDGUCa4NC8sSVW1e6yxsFXksSIgxTkJhkONG6daXkg2Y8cGwaqsrffbt22_Py/pub?gid=1022445244&single=true&output=csv";
  const REFRESH_MS = 5000;

  const gridEl = document.getElementById('grid');
  const statusEl = document.getElementById('status');
  const updatedEl = document.getElementById('updated');
  const batSignalEl = document.getElementById('batsignal');

  // –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É (–ª–æ–∫–∞–ª—å–Ω–∞—è -> fallback)
  (function initImages(){
    var bg = document.getElementById('bat-bg-img');
    var sg = document.getElementById('batsignal-img');
    bg.referrerPolicy = 'no-referrer';
    sg.referrerPolicy = 'no-referrer';

    // —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
    bg.src = BAT_IMG_LOCAL;
    sg.src = BAT_IMG_LOCAL;

    // –µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Äî —Å—Ç–∞–≤–∏–º fallback
    bg.onerror = function(){ bg.onerror=null; bg.src = BAT_IMG_FALLBACK; };
    sg.onerror = function(){ sg.onerror=null; sg.src = BAT_IMG_FALLBACK; };
  })();

  const medalOrder = { gold:0, silver:1, bronze:2, "":3 };
  function medalType(str){
    var s = (str||'').toLowerCase();
    if (s.indexOf('–∑–æ–ª')>-1 || s.indexOf('gold')>-1) return 'gold';
    if (s.indexOf('—Å–µ—Ä')>-1 || s.indexOf('silver')>-1) return 'silver';
    if (s.indexOf('–±—Ä–æ–Ω')>-1|| s.indexOf('bronze')>-1) return 'bronze';
    return '';
  }
  function medalEmoji(type){ return type==='gold'?'ü•á':type==='silver'?'ü•à':type==='bronze'?'ü•â':''; }

  async function fetchCSV(){
    try{
      statusEl.innerHTML = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶ <span class="blink">‚óè</span>';
      var res = await fetch(CSV_URL + '&_=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      var text = await res.text();
      var parsed = Papa.parse(text, { skipEmptyLines: "greedy" });
      render(parsed.data);
      statusEl.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ';
      updatedEl.textContent = '–í—Ä–µ–º—è: ' + new Date().toLocaleTimeString();
    }catch(e){
      console.error(e);
      statusEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV';
    }
  }

  function render(rows){
    if(!rows || !rows.length){
      gridEl.innerHTML = '';
      batSignalEl.classList.remove('show');
      return;
    }
    var header = rows[0].map(function(h){ return (h||'').toString().trim().toLowerCase(); });
    var hasHdr = header.some(function(h){
      return h.indexOf('—Ñ–∏–æ')>-1 || h.indexOf('name')>-1 ||
             h.indexOf('–∏—Ç–æ–≥–æ')>-1 || h.indexOf('score')>-1 ||
             h.indexOf('–º–µ–¥–∞–ª')>-1 || h.indexOf('medal')>-1 ||
             h.indexOf('–∫–ª–∞—Å—Å')>-1 || h.indexOf('class')>-1;
    });
    var body = rows.slice(hasHdr?1:0);

    var idxName  = hasHdr ? header.findIndex(h=>h.indexOf('—Ñ–∏–æ')>-1 || h.indexOf('name')>-1)   : 0;
    var idxScore = hasHdr ? header.findIndex(h=>h.indexOf('–∏—Ç–æ–≥–æ')>-1 || h.indexOf('score')>-1) : 1;
    var idxMedal = hasHdr ? header.findIndex(h=>h.indexOf('–º–µ–¥–∞–ª')>-1 || h.indexOf('medal')>-1) : 2;
    var idxClass = hasHdr ? header.findIndex(h=>h.indexOf('–∫–ª–∞—Å—Å')>-1 || h.indexOf('class')>-1) : 3;
    if(idxName<0) idxName=0; if(idxScore<0) idxScore=1; if(idxMedal<0) idxMedal=2; if(idxClass<0) idxClass=3;

    var data = body.map(function(r){
      var name  = (r[idxName]  || '').toString().trim();
      var score = parseFloat((r[idxScore] || '0').toString().replace(',','.')) || 0;
      var medal = (r[idxMedal] || '').toString().trim();
      var klass = (r[idxClass] || '').toString().trim();
      return { name:name, score:Math.round(score), medal:medal, klass:klass };
    }).filter(function(r){ return r.name; });

    data.sort(function(a,b){
      var ma = medalType(a.medal), mb = medalType(b.medal);
      var byM = (medalOrder[ma]||3) - (medalOrder[mb]||3); if(byM) return byM;
      var byS = (b.score||0) - (a.score||0);               if(byS) return byS;
      return a.name.localeCompare(b.name,'ru');
    });

    // –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å–∏–≥–Ω–∞–ª
    var top = data.length ? data[0] : null;
    if(top && medalType(top.medal)==='gold') batSignalEl.classList.add('show');
    else batSignalEl.classList.remove('show');

    gridEl.innerHTML = '';
    data.forEach(function(row,i){
      var t = medalType(row.medal), e = medalEmoji(t);
      var el = document.createElement('div'); el.className='tile';
      el.innerHTML =
        '<div class="left">' +
          '<div class="rank">'+(i+1)+'</div>' +
          '<div>' +
            '<div class="name">'+(e?e+' ':'')+row.name+'</div>' +
            (row.klass ? '<div class="class">–ö–ª–∞—Å—Å: '+row.klass+'</div>' : '') +
          '</div>' +
        '</div>' +
        '<div class="right">' +
          (e?'<div class="medal" data-type="'+t+'">'+e+'</div>':'') +
          '<div class="score">'+row.score+'</div>' +
        '</div>';
      gridEl.appendChild(el);
    });
  }

  fetchCSV();
  setInterval(fetchCSV, REFRESH_MS);
</script>
</body>
</html>
