<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–®–∫–æ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî Online</title>
<style>
  :root{--bg:#0b1220;--muted:#7e8aa3;--text:#e8eefc;--gold:#ffcc33;--silver:#c0c7d1;--bronze:#d28b5b}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 20% -10%,#142040 0%,#0b1220 60%);
       font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text)}
  .wrap{max-width:1400px;margin:0 auto;padding:24px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .title{font-weight:800;letter-spacing:.5px;font-size:clamp(22px,3vw,36px)}
  .subtitle{color:var(--muted);font-size:clamp(12px,1.5vw,16px)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
  @media (max-width:1200px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:700px){.grid{grid-template-columns:1fr}}
  .tile{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
        border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:14px 16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .left{display:flex;align-items:center;gap:12px;min-width:0}
  .rank{width:40px;height:40px;border-radius:10px;display:grid;place-items:center;font-weight:800;background:#0f1730;border:1px solid rgba(255,255,255,.08)}
  .name{font-weight:700;letter-spacing:.3px;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .right{display:flex;align-items:center;gap:14px}
  .score{font-weight:800;min-width:54px;text-align:right;font-size:20px}
  .medal{font-size:26px}
  .footer{margin-top:10px;display:flex;justify-content:space-between;color:var(--muted);font-size:12px}
  .blink{animation:blink 1.2s linear infinite}@keyframes blink{50%{opacity:.35}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">–®–∫–æ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî Online</div>
      <div class="subtitle">–ò—Å—Ç–æ—á–Ω–∏–∫: Google Sheets (–õ–∏—Å—Ç2, CSV). –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥.</div>
    </div>
    <div class="subtitle" id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </header>

  <div id="grid" class="grid"></div>

  <div class="footer">
    <span id="updated"></span>
    <span>–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º (F11) –Ω–∞ –¢–í</span>
  </div>
</div>

<!-- PapaParse –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // === –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–≤–æ–π Google Sheets (–õ–∏—Å—Ç2 –≤ CSV)
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-yAedPlzSiucopAyXDGUcA4NC8sSVW1e6yxsFXksSIgxTkJhkONG6daXkg2Y8cGwaqsrfbt22_Py/pub?gid=1022445244&single=true&output=csv";
  const REFRESH_MS = 5000;

  const gridEl = document.getElementById('grid');
  const statusEl = document.getElementById('status');
  const updatedEl = document.getElementById('updated');

  const medalOrder = { gold:0, silver:1, bronze:2, "":3 };
  function medalType(str){
    const s = (str||'').toString().toLowerCase();
    if (s.includes('ü•á') || s.includes('–∑–æ–ª') || s.includes('gold'))   return 'gold';
    if (s.includes('ü•à') || s.includes('—Å–µ—Ä') || s.includes('silver')) return 'silver';
    if (s.includes('ü•â') || s.includes('–±—Ä–æ–Ω')|| s.includes('bronze')) return 'bronze';
    return '';
  }
  function medalEmoji(type){
    if(type==='gold')   return 'ü•á';
    if(type==='silver') return 'ü•à';
    if(type==='bronze') return 'ü•â';
    return '';
  }

  async function fetchCSV(){
    try{
      statusEl.innerHTML = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶ <span class="blink">‚óè</span>';
      const res = await fetch(CSV_URL + '&_=' + Date.now(), {cache:'no-store'});
      const text = await res.text();
      const parsed = Papa.parse(text, { skipEmptyLines: "greedy" });
      render(parsed.data);
      statusEl.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–æ';
      updatedEl.textContent = '–í—Ä–µ–º—è: ' + new Date().toLocaleTimeString();
    }catch(e){
      statusEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV';
      console.error(e);
    }
  }

  function render(rows){
    if (!rows || rows.length === 0) {
      statusEl.textContent = 'CSV –ø—É—Å—Ç–æ–π';
      return;
    }

    // --- –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –µ—Å—Ç—å –ª–∏ —à–∞–ø–∫–∞
    const headerRaw = rows[0].map(x => (x||'').toString().trim());
    const header = headerRaw.map(h => h.toLowerCase());
    const hasHeaderHints = header.some(h =>
      h.includes('—Ñ–∏–æ') || h.includes('name') ||
      h.includes('–∏—Ç–æ–≥–æ') || h.includes('score') || h.includes('–æ—á–∫–∏') ||
      h.includes('–º–µ–¥–∞–ª') || h.includes('medal')
    );

    const body = rows.slice(hasHeaderHints ? 1 : 0);

    let idxName  = hasHeaderHints ? header.findIndex(h=>h.includes('—Ñ–∏–æ')||h.includes('name'))   : 0;
    let idxScore = hasHeaderHints ? header.findIndex(h=>h.includes('–∏—Ç–æ–≥–æ')||h.includes('score')||h.includes('–æ—á–∫–∏')): 1;
    let idxMedal = hasHeaderHints ? header.findIndex(h=>h.includes('–º–µ–¥–∞–ª')||h.includes('medal')): 2;

    if (idxName  < 0) idxName  = 0;
    if (idxScore < 0) idxScore = 1;
    if (idxMedal < 0) idxMedal = 2;

    const data = body.map(r=>{
      const name  = (r[idxName]  ?? '').toString().trim();
      const score = parseFloat((r[idxScore] ?? '0').toString().replace(',', '.')) || 0;
      // –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –º–µ–¥–∞–ª–∏ –ø—É—Å—Ç–∞—è ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ –≤—Å–µ–º —è—á–µ–π–∫–∞–º —Å—Ç—Ä–æ–∫–∏
      let medal = (r[idxMedal] ?? '').toString().trim();
      if(!medal){
        for(const c of r){
          const s = (c||'').toString().toLowerCase();
          if (s.includes('–∑–æ–ª')||s.includes('—Å–µ—Ä')||s.includes('–±—Ä–æ–Ω')||s.includes('gold')||s.includes('silver')||s.includes('bronze')||s.includes('ü•á')||s.includes('ü•à')||s.includes('ü•â')){
            medal = (c||'').toString().trim(); break;
          }
        }
      }
      return { name, score: Math.round(score), medal };
    }).filter(r=>r.name);

    // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: ü•á ‚Üí ü•à ‚Üí ü•â ‚Üí –æ—á–∫–∏ ‚Üì ‚Üí –§–ò–û ‚Üë
    data.sort((a,b)=>{
      const ma = medalType(a.medal), mb = medalType(b.medal);
      const byMedal = medalOrder[ma] - medalOrder[mb];
      if(byMedal) return byMedal;
      const byScore = (b.score||0) - (a.score||0);
      if(byScore) return byScore;
      return a.name.localeCompare(b.name,'ru');
    });

    gridEl.innerHTML = '';
    data.forEach((row,i)=>{
      const mtype = medalType(row.medal);
      const memoji = medalEmoji(mtype);
      const tile = document.createElement('div'); tile.className='tile';
      tile.title = row.medal || '';
      tile.innerHTML = `
        <div class="left">
          <div class="rank">${i+1}</div>
          <div class="name">${memoji ? memoji+' ' : ''}${row.name}</div>
        </div>
        <div class="right">
          ${memoji ? `<div class="medal" data-type="${mtype}">${memoji}</div>` : ''}
          <div class="score">${row.score}</div>
        </div>`;
      gridEl.appendChild(tile);
    });
  }

  fetchCSV();
  setInterval(fetchCSV, REFRESH_MS);
</script>
</body>
</html>
