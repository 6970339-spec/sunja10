<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Школьный рейтинг — Online</title>
<style>
  :root{
    --bg:#0b1220; --muted:#7e8aa3; --text:#e8eefc;
    --gold:#ffd54a;
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 800px at 20% -10%,#162554 0%,#0b1220 60%) fixed;
    overflow-x:hidden;
  }

  /* Силуэт города внизу (inline SVG) */
  .city {
    position: fixed; left:0; right:0; bottom:0; height:160px; z-index:0;
    background:
      linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0)) 0 0/100% 100%,
      url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="1600" height="160" viewBox="0 0 1600 160">\
        <rect width="1600" height="160" fill="%230a1326"/>\
        <path d="M0,140 h80 v-40 h40 v-60 h60 v60 h40 v-30 h40 v30 h50 v-70 h70 v70 h40 v-40 h50 v40 h60 v-90 h60 v90 h60 v-50 h40 v50 h70 v-30 h30 v30 h70 v-110 h50 v110 h80 v20 H0z" fill="%2312213f"/>\
        <path d="M0,150 h90 v-30 h30 v-60 h40 v60 h50 v-40 h40 v40 h50 v-70 h60 v70 h40 v-30 h60 v30 h70 v-100 h40 v100 h50 v-50 h60 v50 h90 v10 H0z" fill="%23152a52"/>\
      </svg>') repeat-x bottom left / cover;
    opacity:.85; pointer-events:none;
  }

  .wrap{max-width:800px;margin:0 auto;padding:20px; position:relative; z-index:1}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .title{
    display:flex; align-items:center; gap:10px;
    font-weight:800; letter-spacing:.5px;
    font-size:clamp(22px,3vw,36px);
  }
  .subtitle{color:var(--muted);font-size:14px}

  .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:16px}
  .tile{
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
    border:1px solid rgba(255,255,255,.06);
    border-radius:14px;padding:12px 14px;box-shadow:0 4px 12px rgba(0,0,0,.25)
  }
  .left{display:flex;align-items:center;gap:12px;min-width:0}
  .rank{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;
        font-weight:800;background:#0f1730;border:1px solid rgba(255,255,255,.08)}
  .name{font-weight:700;letter-spacing:.3px;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .class{font-size:14px;color:var(--muted)}
  .right{display:flex;align-items:center;gap:12px}
  .score{font-weight:800;min-width:48px;text-align:right;font-size:18px}
  .medal{font-size:24px}

  .footer{margin-top:12px;display:flex;justify-content:space-between;color:#7e8aa3;font-size:12px}
  .blink{animation:blink 1.2s linear infinite}@keyframes blink{50%{opacity:.35}}

  /* ───────────────────────────
     Bat-Signal встроенный в заголовок
     ─────────────────────────── */
  .batsignal{
    position: relative;                 /* встроен в строку заголовка */
    width: 150px; height: 68px;         /* компактно */
    display: inline-block;
    vertical-align: middle;
    margin-right: 6px;

    opacity: 0; transform: translateY(-4px) scale(.96);
  }
  .batsignal.show{
    opacity:1; transform: translateY(0) scale(1);
    transition: opacity .45s ease, transform .45s ease;
  }

  /* эффекты включения/выключения */
  .batsignal.on  .beam { animation: powerOn .5s ease both;  }
  .batsignal.off .beam { animation: powerOff .5s ease both; }
  @keyframes powerOn  { from{opacity:0; transform:scaleX(.7)} to{opacity:1; transform:scaleX(1)} }
  @keyframes powerOff { from{opacity:1; transform:scaleX(1)} to{opacity:0; transform:scaleX(.7)} }

  /* луч: конус слева→вправо */
  .batsignal .beam{
    position:absolute; left:56px; top:8px; right:0; bottom:8px;
    transform-origin: left center;
  }
  .batsignal .beam-core{
    position:absolute; inset:0;
    clip-path: polygon(0% 48%, 100% 18%, 100% 82%, 0% 58%);
    background: linear-gradient(90deg,
                rgba(255,238,170,.30),
                rgba(255,238,170,.08) 70%,
                rgba(255,238,170,0) 100%);
    filter: blur(.9px);
    animation: coreFlicker 3.6s ease-in-out infinite, sway 9s ease-in-out infinite;
  }
  @keyframes coreFlicker{ 0%,100%{opacity:.93} 40%{opacity:.86} 50%{opacity:1} 60%{opacity:.9}}
  @keyframes sway       { 0%,100%{ transform: rotate(-0.35deg)} 50%{ transform: rotate(0.35deg)} }

  .batsignal .beam-sweep{
    position:absolute; inset:0;
    clip-path: polygon(0% 48%, 100% 18%, 100% 82%, 0% 58%);
    background:
      linear-gradient(90deg, transparent 0%,
                               rgba(255,245,180,.45) 10%,
                               rgba(255,245,180,.9) 13%,
                               rgba(255,245,180,.45) 16%,
                               transparent 26%);
    filter: blur(1px);
    mix-blend-mode: screen;
    opacity:.65;
    animation: sweepX 5.2s ease-in-out infinite;
  }
  @keyframes sweepX{
    0%   { background-position: -40% 0; background-size: 200% 100% }
    50%  { background-position:  60% 0; background-size: 200% 100% }
    100% { background-position: -40% 0; background-size: 200% 100% }
  }

  .batsignal .beam-dust{
    position:absolute; inset:3% 2%;
    clip-path: polygon(0% 48%, 100% 18%, 100% 82%, 0% 58%);
    background:
      radial-gradient(1.8px 1.8px at 12% 78%, rgba(255,255,210,.25) 0, rgba(255,255,210,0) 60%),
      radial-gradient(1.8px 1.8px at 32% 60%, rgba(255,255,210,.18) 0, rgba(255,255,210,0) 60%),
      radial-gradient(1.8px 1.8px at 56% 70%, rgba(255,255,210,.22) 0, rgba(255,255,210,0) 60%),
      radial-gradient(1.8px 1.8px at 76% 50%, rgba(255,255,210,.16) 0, rgba(255,255,210,0) 60%);
    filter: blur(.25px);
    opacity:.6;
    animation: dustDrift 9s linear infinite;
  }
  @keyframes dustDrift{
    0%   { transform: translateX(-1%) translateY(6%) }
    100% { transform: translateX( 1%) translateY(-6%) }
  }

  /* корпус прожектора (твоя PNG) */
  .batsignal .projector{
    position:absolute; left:0; bottom:2px;
    width: 56px; height: 56px; object-fit: contain;
    transform-origin: 40% 70%;
    transform: rotate(-6deg);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,.55));
    animation: projectorWobble 11s ease-in-out infinite;
  }
  @keyframes projectorWobble{
    0%,100%{ transform: rotate(-6deg) translateY(0) }
    50%    { transform: rotate(-5deg) translateY(-1px) }
  }

  /* ───────────────────────────
     Анимация Бэтмена и Джокера
     ─────────────────────────── */
  .hero-villain {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
    pointer-events: none; opacity: 0; visibility: hidden;
  }
  .hero-villain.show {
    opacity: 1; visibility: visible;
    transition: opacity .6s ease;
  }
  .batman-silhouette, .joker-silhouette {
    position: absolute; width: 120px; height: 120px;
    filter: drop-shadow(0 8px 16px rgba(0,0,0,.8));
  }
  .batman-silhouette {
    top: -100px; left: 50%; transform: translateX(-50%);
    animation: batmanDrop 2s ease-out forwards;
  }
  @keyframes batmanDrop {
    to { top: 20%; transform: translateX(-50%) rotate(5deg); }
  }
  .joker-silhouette {
    bottom: -100px; right: 10%; transform: scale(0) rotate(180deg);
    animation: jokerPop 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  }
  @keyframes jokerPop {
    0% { transform: scale(0) rotate(180deg); }
    50% { transform: scale(1.2) rotate(0deg); }
    100% { transform: scale(1) rotate(360deg); bottom: 30%; }
  }
  .joker-laugh {
    position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
    color: #00ff41; font-family: 'Courier New', monospace; font-size: 24px;
    font-weight: bold; letter-spacing: 2px; opacity: 0;
    animation: laughBlink 0.8s ease-in-out 1s forwards infinite 3;
  }
  @keyframes laughBlink {
    0%, 100% { opacity: 0; }
    20%, 80% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Inline SVG для силуэтов */
  .batman-svg {
    width: 100%; height: 100%;
    fill: #1a1a1a; /* Тёмный */
  }
  .joker-svg {
    width: 100%; height: 100%;
    fill: #00ff41; /* Зелёный, как у Джокера */
  }
</style>
</head>
<body>

  <div class="wrap">
    <header>
      <div class="title">
        <!-- ВСТРОЕННЫЙ ПРОЖЕКТОР ВМЕСТО ЛОГО -->
        <div id="batsignal" class="batsignal" aria-hidden="true">
          <div class="beam">
            <div class="beam-core"></div>
            <div class="beam-sweep"></div>
            <div class="beam-dust"></div>
          </div>
          <img class="projector" src="bat-signal.png" alt="">
        </div>
        Школьный рейтинг — Online
      </div>
      <div class="subtitle" id="status">Загрузка…</div>
    </header>

    <div id="grid" class="grid"></div>

    <div class="footer">
      <span id="updated"></span>
      <span>Полноэкранный режим (F11) на ТВ</span>
    </div>
  </div>

  <div id="hero-villain" class="hero-villain" aria-hidden="true">
    <!-- Бэтмен -->
    <svg class="batman-silhouette batman-svg" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
      <path d="M50 10 Q30 30 20 60 Q10 90 30 100 Q50 110 70 100 Q90 90 80 60 Q70 30 50 10 Z M30 40 L40 60 L50 50 L60 60 L70 40" /> <!-- Упрощённый плащ + уши -->
    </svg>
    <!-- Джокер -->
    <svg class="joker-silhouette joker-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <path d="M50 20 C30 20 20 40 20 50 C20 60 30 80 50 80 C70 80 80 60 80 50 C80 40 70 20 50 20 Z M40 45 Q50 55 60 45 M30 60 Q50 70 70 60" /> <!-- Улыбка + волосы -->
      <text class="joker-laugh" y="90">HA HA HA</text>
    </svg>
  </div>

  <div class="city" aria-hidden="true"></div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-yAedPlzSiucopAyXDGUCa4NC8sSVW1e6yxsFXksSIgxTkJhkONG6daXkg2Y8cGwaqsrffbt22_Py/pub?gid=1022445244&single=true&output=csv";
  const REFRESH_MS = 5000;

  const gridEl    = document.getElementById('grid');
  const statusEl  = document.getElementById('status');
  const updatedEl = document.getElementById('updated');
  const batSignalEl = document.getElementById('batsignal');
  const heroVillainEl = document.getElementById('hero-villain');

  let signalOn = false;

  const medalOrder = { gold:0, silver:1, bronze:2, "":3 };
  const medalType = (str)=>{
    const s = (str||'').toLowerCase();
    if (s.includes('зол') || s.includes('gold')) return 'gold';
    if (s.includes('сер') || s.includes('silver')) return 'silver';
    if (s.includes('брон')|| s.includes('bronze')) return 'bronze';
    return '';
  };
  const medalEmoji = (t)=> t==='gold'?'🥇':t==='silver'?'🥈':t==='bronze'?'🥉':'';

  function powerOn(){
    if (signalOn) return;
    signalOn = true;
    batSignalEl.classList.add('show','on');
    batSignalEl.classList.remove('off');
    setTimeout(()=>batSignalEl.classList.remove('on'), 520);
  }
  function powerOff(){
    if (!signalOn) return;
    signalOn = false;
    batSignalEl.classList.add('off');
    setTimeout(()=>{ batSignalEl.classList.remove('off','show'); }, 520);
  }

  async function fetchCSV(){
    try{
      statusEl.innerHTML = 'Обновление… <span class="blink">●</span>';
      const res = await fetch(CSV_URL + '&_=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      const parsed = Papa.parse(text, { skipEmptyLines: "greedy" });
      render(parsed.data);
      statusEl.textContent = 'Обновлено';
      updatedEl.textContent = 'Время: ' + new Date().toLocaleTimeString();
    }catch(e){
      statusEl.textContent = 'Ошибка загрузки CSV';
      console.error(e);
    }
  }

  function render(rows){
    if(!rows || rows.length===0){
      gridEl.innerHTML='';
      powerOff();
      return;
    }

    const header = rows[0].map(h => (h||'').toString().trim().toLowerCase());
    const hasHdr = header.some(h =>
      h.includes('фио')||h.includes('name')||
      h.includes('итого')||h.includes('score')||
      h.includes('медал')||h.includes('medal')||
      h.includes('класс')||h.includes('class')
    );
    const body = rows.slice(hasHdr?1:0);

    let idxName  = hasHdr ? header.findIndex(h=>h.includes('фио')||h.includes('name'))   : 0;
    let idxScore = hasHdr ? header.findIndex(h=>h.includes('итого')||h.includes('score')) : 1;
    let idxMedal = hasHdr ? header.findIndex(h=>h.includes('медал')||h.includes('medal')) : 2;
    let idxClass = hasHdr ? header.findIndex(h=>h.includes('класс')||h.includes('class')) : 3;
    if(idxName<0) idxName=0; if(idxScore<0) idxScore=1; if(idxMedal<0) idxMedal=2; if(idxClass<0) idxClass=3;

    const data = body.map(r=>{
      const name  = (r[idxName]  ?? '').toString().trim();
      const score = parseFloat((r[idxScore] ?? '0').toString().replace(',','.')) || 0;
      const medal = (r[idxMedal] ?? '').toString().trim();
      const klass = (r[idxClass] ?? '').toString().trim();
      return { name, score: Math.round(score), medal, klass };
    }).filter(r=>r.name);

    // сортировка: 🥇 → 🥈 → 🥉 → очки ↓ → ФИО ↑
    data.sort((a,b)=>{
      const ma = medalType(a.medal), mb = medalType(b.medal);
      const byM = (medalOrder[ma]??3)-(medalOrder[mb]??3); if(byM) return byM;
      const byS = (b.score||0)-(a.score||0);               if(byS) return byS;
      return a.name.localeCompare(b.name,'ru');
    });

    // включаем/выключаем прожектор по медали лидера
    const topMedal = medalType(data[0]?.medal);
    heroVillainEl.className = 'hero-villain'; // Сброс
    heroVillainEl.innerHTML = ''; // Очистка

    if (topMedal === 'gold') {
      powerOn();
      // Бэтмен для золота
      const batman = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      batman.className = 'batman-silhouette batman-svg';
      batman.setAttribute('viewBox', '0 0 100 120');
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M50 10 Q30 30 20 60 Q10 90 30 100 Q50 110 70 100 Q90 90 80 60 Q70 30 50 10 Z M30 40 L40 60 L50 50 L60 60 L70 40');
      batman.appendChild(path);
      heroVillainEl.appendChild(batman);
      setTimeout(() => heroVillainEl.classList.add('show'), 100);
    } else if (topMedal === 'silver') {
      powerOff();
      // Джокер для серебра
      const joker = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      joker.className = 'joker-silhouette joker-svg';
      joker.setAttribute('viewBox', '0 0 100 100');
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M50 20 C30 20 20 40 20 50 C20 60 30 80 50 80 C70 80 80 60 80 50 C80 40 70 20 50 20 Z M40 45 Q50 55 60 45 M30 60 Q50 70 70 60');
      joker.appendChild(path);
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.className = 'joker-laugh';
      text.setAttribute('y', '90');
      text.textContent = 'HA HA HA';
      joker.appendChild(text);
      heroVillainEl.appendChild(joker);
      setTimeout(() => heroVillainEl.classList.add('show'), 100);
    } else {
      powerOff();
      heroVillainEl.classList.remove('show');
    }

    // Авто-скрытие через 3 сек
    setTimeout(() => heroVillainEl.classList.remove('show'), 3000);

    // рендер списка
    gridEl.innerHTML='';
    data.forEach((row,i)=>{
      const t = medalType(row.medal), e = medalEmoji(t);
      const el = document.createElement('div'); el.className='tile';
      el.innerHTML = `
        <div class="left">
          <div class="rank">${i+1}</div>
          <div>
            <div class="name">${e?e+' ':''}${row.name}</div>
            ${row.klass ? `<div class="class">Класс: ${row.klass}</div>` : ""}
          </div>
        </div>
        <div class="right">
          ${e?`<div class="medal" data-type="${t}">${e}</div>`:''}
          <div class="score">${row.score}</div>
        </div>`;
      gridEl.appendChild(el);
    });
  }

  fetchCSV();
  setInterval(fetchCSV, REFRESH_MS);
</script>
</body>
</html>
