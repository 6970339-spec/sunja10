<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Школьный рейтинг — Online</title>
<style>
  :root{
    --bg:#0b1220; --muted:#7e8aa3; --text:#e8eefc; --gold:#ffd54a;

    /* Адаптивные размеры */
    --cityH: clamp(110px, 18vh, 180px);             /* высота города снизу */
    --disc:  clamp(48px, 7vmin, 96px);              /* диаметр диска */
    --thin:  clamp(1.5px, .35vmin, 3px);            /* толщина у основания */
    --beam:  clamp(400px, 50vw + 40vh, 900px);      /* длина луча */
    --sweep: 8s;                                    /* скорость бегущей полосы */
    --angle: -22deg;                                /* наклон луча (fallback) */
    --baseX: clamp(14px, 8vw, 140px);               /* смещение базы по X */
    --discOverlap: 4px;                             /* заход луча под диск */

    /* Отступы под «безрамочные» телефоны */
    --safeB: env(safe-area-inset-bottom, 0px);
  }

  @media (max-width: 480px){
    :root{
      --angle: -18deg;
      --baseX: clamp(8px, 10vw, 80px);
    }
  }
  @media (min-width: 1024px){
    :root{
      --angle: -25deg;
      --baseX: clamp(24px, 7vw, 180px);
    }
  }

  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 800px at 20% -10%,#162554 0%,#0b1220 60%) fixed;
    overflow-x:hidden;
  }

  /* Город — поверх луча, под контентом */
  .city{
    position: fixed; left:0; right:0; bottom:0; height:var(--cityH); z-index:1;
    background:
      linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0)) 0 0/100% 100%,
      url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="1600" height="160" viewBox="0 0 1600 160">\
        <rect width="1600" height="160" fill="%230a1326"/>\
        <path d="M0,140 h80 v-40 h40 v-60 h60 v60 h40 v-30 h40 v30 h50 v-70 h70 v70 h40 v-40 h50 v40 h60 v-90 h60 v90 h60 v-50 h40 v50 h70 v-30 h30 v30 h70 v-110 h50 v110 h80 v20 H0z" fill="%2312213f"/>\
        <path d="M0,150 h90 v-30 h30 v-60 h40 v60 h50 v-40 h40 v40 h50 v-70 h60 v70 h40 v-30 h60 v30 h70 v-100 h40 v100 h50 v-50 h60 v50 h90 v10 H0z" fill="%23152a52"/>\
      </svg>') repeat-x bottom left / cover;
    opacity:.85; pointer-events:none;
  }
  .starfall{position:absolute;top:0;left:0;right:0;height:100%;z-index:1;overflow:hidden}
  .meteor{position:absolute;width:2px;height:2px;background:linear-gradient(45deg,rgba(255,255,255,.9),rgba(255,255,255,.2));border-radius:50%;box-shadow:0 0 6px 1px rgba(255,255,255,.4);animation:meteorFall 4s linear infinite}
  .meteor:nth-child(1){left:20%}.meteor:nth-child(2){left:50%;animation-delay:1.5s}.meteor:nth-child(3){left:80%;animation-delay:3s}
  @keyframes meteorFall{0%{transform:translate(0,-100%) rotate(45deg);opacity:1}100%{transform:translate(-100px,100%) rotate(45deg);opacity:0}}

  /* Контент поверх всего */
  .wrap{max-width:800px;margin:0 auto;padding:20px 20px calc(20px + var(--safeB)); position:relative; z-index:2}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .title{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.5px;font-size:clamp(22px,3vw,36px)}
  .subtitle{display:none}
  .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:16px}
  .tile{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:12px 14px;box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .left{display:flex;align-items:center;gap:12px;min-width:0}
  .rank{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;font-weight:800;background:#0f1730;border:1px solid rgba(255,255,255,.08)}
  .name{font-weight:700;letter-spacing:.3px;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .class{font-size:14px;color:var(--muted)}
  .right{display:flex;align-items:center;gap:12px}
  .score{font-weight:800;min-width:48px;text-align:right;font-size:18px}
  .medal{font-size:24px}
  .footer{margin-top:12px;display:flex;justify-content:space-between;color:#7e8aa3;font-size:12px}

  /* ───────────────────────────
     Bat-Signal: луч на заднем плане
     ─────────────────────────── */
  .batsignal{
    position: fixed;
    left: var(--baseX);
    bottom: calc(var(--cityH) - 10px + var(--safeB));
    width: var(--disc);
    height: var(--beam);
    z-index:0;
    pointer-events:none;
    opacity: 0; transform: translateY(4px) scale(.96);
  }
  .batsignal.show{
    opacity: 1; transform: translateY(0) scale(1);
    transition: opacity .45s ease, transform .45s ease;
  }

  .batsignal.on .beam { animation: powerOn .5s ease both; }
  .batsignal.off .beam { animation: powerOff .5s ease both; }
  @keyframes powerOn  { from{opacity:0; transform:scaleY(.7)} to{opacity:1; transform:scaleY(1)} }
  @keyframes powerOff { from{opacity:1; transform:scaleY(1)} to{opacity:0; transform:scaleY(.7)} }

  .batsignal .beam{
    position:absolute; bottom:0; left:50%;
    width: var(--disc); height: var(--beam);
    transform-origin: bottom center;
    transform: translateX(-50%) rotate(var(--angle));
    --beam-clip: polygon(
      calc(50% - var(--thin)) 100%,
      calc(50% + var(--thin)) 100%,
      calc(50% + (var(--disc)/2)) 0%,
      calc(50% - (var(--disc)/2)) 0%
    );
  }
  .batsignal .beam-core,
  .batsignal .beam-sweep,
  .batsignal .beam-dust{ clip-path: var(--beam-clip); }

  .batsignal .beam-core{
    position:absolute; inset:0;
    background: linear-gradient(180deg,
      rgba(255,238,170,.30) 0%,
      rgba(255,238,170,.10) 55%,
      rgba(255,238,170,0)   100%);
    filter: blur( max(.6px, .1vmin) );
    mix-blend-mode: screen;
    animation: coreFlicker 3.6s ease-in-out infinite;
  }
  @keyframes coreFlicker{0%,100%{opacity:.93}40%{opacity:.86}50%{opacity:1}60%{opacity:.9}}

  .batsignal .beam-sweep{
    position:absolute; inset:0;
    background:
      linear-gradient(180deg,
        rgba(255,245,180,.95) 0%,
        rgba(255,245,180,.45) 10%,
        transparent 22%,
        transparent 100%);
    background-size: 100% 260%;
    filter: blur( max(.6px, .15vmin) );
    mix-blend-mode: screen;
    opacity:.7;
    animation: sweepUp var(--sweep) linear infinite;
    animation-play-state: paused;
  }
  .batsignal.show .beam-sweep{ animation-play-state: running; }
  @keyframes sweepUp{ 0%{background-position:0 200%} 100%{background-position:0 -60%} }

  .batsignal .beam-dust{
    position:absolute; inset:2% 6%;
    background:
      radial-gradient(2px 2px at 25% 70%, rgba(255,255,210,.22) 0, rgba(255,255,210,0) 60%),
      radial-gradient(2px 2px at 55% 45%, rgba(255,255,210,.18) 0, rgba(255,255,210,0) 60%),
      radial-gradient(2px 2px at 78% 35%, rgba(255,255,210,.20) 0, rgba(255,255,210,0) 60%),
      radial-gradient(2px 2px at 40% 20%, rgba(255,255,210,.16) 0, rgba(255,255,210,0) 60%);
    filter: blur(.35px);
    opacity:.6;
    animation: dustDrift 10s linear infinite;
    mix-blend-mode: screen;
  }
  @keyframes dustDrift{0%{transform:translateX(-1%) translateY(4%)}100%{transform:translateX(1%) translateY(-4%)}}

  /* ───────────────────────────
     Диск в заголовке
     ─────────────────────────── */
  .batdisc{
    position: relative;
    width: calc(var(--disc) + 16px);
    height: calc(var(--disc) + 16px);
    display: inline-block; vertical-align: middle;
    margin-right: 6px;
    overflow: visible;
    opacity: 0; transform: translateY(-4px) scale(.96);
  }
  .batdisc.show{
    opacity: 1; transform: translateY(0) scale(1);
    transition: opacity .45s ease, transform .45s ease;
  }

  .batdisc .target{
    position: absolute;
    left: -4px; top: 8px;
    width: var(--disc); height: var(--disc);
  }
  .batdisc .target::before{
    content:"";
    position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(circle at 35% 35%, #fff9c9 0%, #ffe58b 50%, #ffd55a 100%);
    box-shadow: 0 0 calc(8px + .4vmin) calc(3px + .2vmin) rgba(255,240,150,.6);
    animation: spotPulse 2.8s ease-in-out infinite;
  }
  @keyframes spotPulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.08)}}

  .batdisc .target-img{
    position:absolute; inset:0; width:100%; height:100%; object-fit:contain;
    filter: drop-shadow(0 0 2px rgba(0,0,0,.35));
  }
</style>
</head>
<body>

  <div class="wrap">
    <header>
      <div class="title">
        <div id="batdisc" class="batdisc" aria-hidden="true">
          <div class="target">
            <img class="target-img" src="bat-signal.png" alt="bat-signal">
          </div>
        </div>
        Школьный рейтинг — Online
      </div>
      <div class="subtitle" id="status"></div>
    </header>

    <div id="grid" class="grid"></div>

    <div class="footer">
      <span id="updated"></span>
      <span>Полноэкранный режим (F11) на ТВ</span>
    </div>
  </div>

  <div class="city" aria-hidden="true">
    <div class="starfall">
      <div class="meteor"></div>
      <div class="meteor"></div>
      <div class="meteor"></div>
    </div>
  </div>

  <!-- Луч на заднем плане -->
  <div id="batsignal" class="batsignal" aria-hidden="true">
    <div class="beam">
      <div class="beam-core"></div>
      <div class="beam-sweep"></div>
      <div class="beam-dust"></div>
    </div>
  </div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-yAedPlzSiucopAyXDGUCa4NC8sSVW1e6yxsFXksSIgxTkJhkONG6daXkg2Y8cGwaqsrffbt22_Py/pub?gid=1022445244&single=true&output=csv";
  const REFRESH_MS = 11000;

  const gridEl    = document.getElementById('grid');
  const updatedEl = document.getElementById('updated');
  const batSignalEl = document.getElementById('batsignal');
  const batDiscEl = document.getElementById('batdisc');

  let signalOn = false;

  function updateBeamAngle() {
    const discRect = batDiscEl.getBoundingClientRect();
    const discX = discRect.left + discRect.width / 2; // Центр диска по X
    const discY = discRect.top + discRect.height / 2; // Центр диска по Y
    const beamOriginX = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--baseX')); // Начало луча по X
    const beamOriginY = window.innerHeight - parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cityH')) + 10; // Начало луча по Y
    const deltaX = discX - beamOriginX;
    const deltaY = discY - beamOriginY;
    const angleRad = Math.atan2(deltaY, deltaX);
    const angleDeg = angleRad * (180 / Math.PI);
    batSignalEl.querySelector('.beam').style.transform = `translateX(-50%) rotate(${angleDeg}deg)`;
  }

  const medalOrder = { gold:0, silver:1, bronze:2, "":3 };
  const medalType = (str)=>{
    const s = (str||'').toLowerCase();
    if (s.includes('зол') || s.includes('gold')) return 'gold';
    if (s.includes('сер') || s.includes('silver')) return 'silver';
    if (s.includes('брон
