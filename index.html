<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–®–∫–æ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî Online</title>
<style>
  :root{
    --bg:#0b1220; --muted:#7e8aa3; --text:#e8eefc;
    --gold:#ffd54a;

    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∂–µ–∫—Ç–æ—Ä–∞ (—Å–Ω–∏–∑—É-–≤–≤–µ—Ä—Ö) */
    --disc: 84px;      /* –¥–∏–∞–º–µ—Ç—Ä –¥–∏—Å–∫–∞-–º–∏—à–µ–Ω–∏ –Ω–∞–≤–µ—Ä—Ö—É (—É–≤–µ–ª–∏—á–∏–ª –∏ —Å–¥–µ–ª–∞–ª –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º) */
    --thin: 3px;       /* —Ç–æ–ª—â–∏–Ω–∞ –ª—É—á–∞ —É –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (—É –æ—Å–Ω–æ–≤–∞–Ω–∏—è –≤ –≥–æ—Ä–æ–¥–µ) */
    --beam: 520px;     /* –¥–ª–∏–Ω–∞ –ª—É—á–∞ –≤–≤–µ—Ä—Ö */
    --sweep: 8s;       /* –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ö–æ–¥–∞ —è—Ä–∫–æ–π –ø–æ–ª–æ—Å—ã */
  }

  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background: radial-gradient(1200px 800px at 20% -10%,#162554 0%,#0b1220 60%) fixed;
    overflow-x:hidden;
  }

  /* –°–∏–ª—É—ç—Ç –≥–æ—Ä–æ–¥–∞ –≤–Ω–∏–∑—É (–¥–µ–∫–æ—Ä) ‚Äî –ø–æ–≤–µ—Ä—Ö –ª—É—á–∞, –Ω–æ –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º */
  .city {
    position: fixed; left:0; right:0; bottom:0; height:160px;
    z-index: 1;
    background:
      linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0)) 0 0/100% 100%,
      url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="1600" height="160" viewBox="0 0 1600 160">\
        <rect width="1600" height="160" fill="%230a1326"/>\
        <path d="M0,140 h80 v-40 h40 v-60 h60 v60 h40 v-30 h40 v30 h50 v-70 h70 v70 h40 v-40 h50 –≤40 h60 v-90 h60 v90 h60 v-50 h40 v50 h70 v-30 h30 v30 h70 v-110 h50 v110 h80 v20 H0z" fill="%2312213f"/>\
        <path d="M0,150 h90 v-30 h30 v-60 h40 v60 h50 v-40 h40 v40 h50 v-70 h60 v70 h40 v-30 h60 v30 h70 v-100 h40 v100 h50 v-50 h60 v50 h90 v10 H0z" fill="%23152a52"/>\
      </svg>') repeat-x bottom left / cover;
    opacity:.85; pointer-events:none;
  }

  /* –ó–≤–µ–∑–¥–æ–ø–∞–¥ ‚Äî —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥–æ—Ä–æ–¥–∞ */
  .starfall {
    position: absolute; top: 0; left: 0; right: 0; height: 160px; z-index: 1;
    overflow: hidden; pointer-events:none;
  }
  .meteor {
    position: absolute; width: 2px; height: 2px;
    background: linear-gradient(45deg, rgba(255,255,255,0.9), rgba(255,255,255,0.2));
    border-radius: 50%;
    box-shadow: 0 0 6px 1px rgba(255,255,255,0.4);
    animation: meteorFall 4s linear infinite;
  }
  .meteor:nth-child(1) { left: 20%; animation-delay: 0s; }
  .meteor:nth-child(2) { left: 50%; animation-delay: 1.5s; }
  .meteor:nth-child(3) { left: 80%; animation-delay: 3s; }
  @keyframes meteorFall {
    0%   { transform: translate(0, -100%) rotate(45deg); opacity: 1; }
    100% { transform: translate(-100px, 160px) rotate(45deg); opacity: 0; }
  }

  /* –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
  .wrap{max-width:800px;margin:0 auto;padding:20px; position:relative; z-index:2}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .title{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px; font-size:clamp(22px,3vw,36px);}
  .subtitle{display:none}

  .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:16px}
  .tile{
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
    border:1px solid rgba(255,255,255,.06);
    border-radius:14px;padding:12px 14px;box-shadow:0 4px 12px rgba(0,0,0,.25)
  }
  .left{display:flex;align-items:center;gap:12px;min-width:0}
  .rank{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;
        font-weight:800;background:#0f1730;border:1px solid rgba(255,255,255,.08)}
  .name{font-weight:700;letter-spacing:.3px;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .class{font-size:14px;color:var(--muted)}
  .right{display:flex;align-items:center;gap:12px}
  .score{font-weight:800;min-width:48px;text-align:right;font-size:18px}
  .medal{font-size:24px}
  .footer{margin-top:12px;display:flex;justify-content:space-between;color:#7e8aa3;font-size:12px}

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     Bat-Signal —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö, –ó–ê–î–ù–ò–ô –ü–õ–ê–ù
     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .batsignal{
    position: fixed;
    left: 80px;
    /* —Å—Ç–∞–≤–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫ —Ä–æ–≤–Ω–æ –æ—Ç ¬´–∫—Ä—ã—à–∏¬ª –≥–æ—Ä–æ–¥–∞ (160px –≤—ã—Å–æ—Ç–∞) + –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å –≤–Ω—É—Ç—Ä—å, —á—Ç–æ–±—ã –±–∞–∑–∞ —Å–∫—Ä—ã–≤–∞–ª–∞—Å—å */
    bottom: 150px;
    width: max(var(--disc), 220px);
    height: calc(var(--beam) + var(--disc) + 32px);
    z-index: 0;              /* –∑–∞ –≥–æ—Ä–æ–¥–æ–º? –Ω–µ—Ç ‚Äî –ü–û–î –≥–æ—Ä–æ–¥–æ–º (–≥–æ—Ä–æ–¥ z=1), –ù–û –ø–µ—Ä–µ–¥ —Ñ–æ–Ω–æ–º */
    pointer-events: none;    /* —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª –∫–ª–∏–∫–∞–º */
    opacity: 0; transform: translateY(4px) scale(.98);
  }
  .batsignal.show{
    opacity: 1; transform: translateY(0) scale(1);
    transition: opacity .45s ease, transform .45s ease;
  }

  .batsignal.on  .beam { animation: powerOn .45s ease both; }
  .batsignal.off .beam { animation: powerOff .45s ease both; }
  @keyframes powerOn  { from{opacity:0; transform:scaleY(.85)} to{opacity:1; transform:scaleY(1)} }
  @keyframes powerOff { from{opacity:1; transform:scaleY(1)}  to{opacity:0; transform:scaleY(.85)} }

  .batsignal .beam{
    position: absolute;
    left: 50%;
    bottom: 0;              /* –±–∞–∑–∞ –ª—É—á–∞ —É –≥–æ—Ä–æ–¥–∞ */
    width: var(--disc);     /* —à–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–∞–≤–Ω–∞ –¥–∏—Å–∫—É, —Å–∞–º –∫–æ–Ω—É—Å —Ä–µ–∂–µ—Ç—Å—è clip-path */
    height: var(--beam);
    transform: translateX(-50%);  /* —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ X */
    /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—É—Å (—Ç–æ–Ω–∫–æ —É –±–∞–∑—ã, —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –¥–æ —à–∏—Ä–∏–Ω—ã –¥–∏—Å–∫–∞ –≤–≤–µ—Ä—Ö—É) */
    --beam-clip: polygon(
      calc(50% - var(--thin)) 100%,
      calc(50% + var(--thin)) 100%,
      calc(50% + (var(--disc)/2)) 0%,
      calc(50% - (var(--disc)/2)) 0%
    );
  }
  .batsignal .beam-core,
  .batsignal .beam-sweep,
  .batsignal .beam-dust{ clip-path: var(--beam-clip); }

  .batsignal .beam-core{
    position: absolute; inset: 0;
    background: linear-gradient(180deg,
                rgba(255,238,170,.30) 0%,
                rgba(255,238,170,.10) 55%,
                rgba(255,238,170,0)   100%);
    filter: blur(1px);
    mix-blend-mode: screen;
    animation: coreFlicker 3.6s ease-in-out infinite;
  }
  @keyframes coreFlicker{ 0%,100%{opacity:.93} 40%{opacity:.86} 50%{opacity:1} 60%{opacity:.9}}

  .batsignal .beam-sweep{
    position: absolute; inset: 0;
    background:
      linear-gradient(180deg, 
        rgba(255,245,180,.9) 0%,
        rgba(255,245,180,.45) 8%,
        transparent 18%,
        transparent 100%);
    background-size: 100% 260%;
    filter: blur(1px);
    mix-blend-mode: screen;
    opacity:.7;
    animation: sweepUp var(--sweep) linear infinite;
    animation-play-state: paused; /* –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ .show */
  }
  @keyframes sweepUp{
    0%   { background-position: 0 200%; }
    100% { background-position: 0 -60%; }
  }
  .batsignal.show .beam-sweep{ animation-play-state: running; }

  .batsignal .beam-dust{
    position: absolute; inset: 2% 6%;
    background:
      radial-gradient(2px 2px at 25% 70%, rgba(255,255,210,.22) 0, rgba(255,255,210,0) 60%),
      radial-gradient(2px 2px at 55% 45%, rgba(255,255,210,.18) 0, rgba(255,255,210,0) 60%),
      radial-gradient(2px 2px at 78% 35%, rgba(255,255,210,.20) 0, rgba(255,255,210,0) 60%),
      radial-gradient(2px 2px at 40% 20%, rgba(255,255,210,.16) 0, rgba(255,255,210,0) 60%);
    filter: blur(.35px);
    opacity: .6;
    animation: dustDrift 10s linear infinite;
    mix-blend-mode: screen;
  }
  @keyframes dustDrift{
    0%   { transform: translateX(-1%) translateY(4%) }
    100% { transform: translateX(1%)  translateY(-4%) }
  }

  /* –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –¥–∏—Å–∫-–º–∏—à–µ–Ω—å, —á—É—Ç—å ¬´–∑–∞—Ö–æ–¥–∏—Ç¬ª –≤ –ª—É—á */
  .batsignal .target{
    position: absolute;
    left: 50%;
    bottom: calc(var(--beam) - 4px);   /* –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞—Ö–æ–¥ –≤ –ª—É—á */
    width: var(--disc); height: var(--disc);
    transform: translateX(-50%);
  }
  .batsignal .target::before{
    content: "";
    position: absolute; inset: 0; border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, #fff9c9 0%, #ffe58b 50%, #ffd55a 100%);
    box-shadow: 0 0 16px 6px rgba(255, 240, 150, 0.6);
    animation: spotPulse 2.8s ease-in-out infinite;
  }
  @keyframes spotPulse { 0%,100%{ filter:brightness(1) } 50%{ filter:brightness(1.08) } }

  .batsignal .target-img{
    position: absolute; inset: 0;
    width: 100%; height: 100%; object-fit: contain;
    filter: drop-shadow(0 0 2px rgba(0,0,0,.35));
    opacity: 1;
  }
</style>
</head>
<body>

  <div class="wrap">
    <header>
      <div class="title">–®–∫–æ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî Online</div>
      <div class="subtitle" id="status"></div>
    </header>

    <div id="grid" class="grid"></div>

    <div class="footer">
      <span id="updated"></span>
      <span>–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º (F11) –Ω–∞ –¢–í</span>
    </div>
  </div>

  <div class="city" aria-hidden="true">
    <div class="starfall">
      <div class="meteor"></div>
      <div class="meteor"></div>
      <div class="meteor"></div>
    </div>
  </div>

  <!-- –õ–£–ß: –∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω (z=0), –ù–ï –º–µ—à–∞–µ—Ç –∫–ª–∏–∫–∞–º, –±–∞–∑–∞ ¬´–ø—Ä—è—á–µ—Ç—Å—è¬ª –≤ –≥–æ—Ä–æ–¥–µ (z=1) -->
  <div id="batsignal" class="batsignal" aria-hidden="true">
    <div class="beam">
      <div class="beam-core"></div>
      <div class="beam-sweep"></div>
      <div class="beam-dust"></div>
    </div>
    <div class="target">
      <!-- –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –≤–µ—Ä–Ω–∏—Ç–µ —Å–≤–æ–π –ª–æ–≥–æ—Ç–∏–ø: -->
      <!-- <img class="target-img" src="bat-signal.png" alt="bat-signal"> -->
    </div>
  </div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-yAedPlzSiucopAyXDGUCa4NC8sSVW1e6yxsFXksSIgxTkJhkONG6daXkg2Y8cGwaqsrffbt22_Py/pub?gid=1022445244&single=true&output=csv";
  const REFRESH_MS = 11000;

  const gridEl    = document.getElementById('grid');
  const updatedEl = document.getElementById('updated');
  const batSignalEl = document.getElementById('batsignal');

  let signalOn = false;

  const medalOrder = { gold:0, silver:1, bronze:2, "":3 };
  const medalType = (str)=>{
    const s = (str||'').toLowerCase();
    if (s.includes('–∑–æ–ª') || s.includes('gold')) return 'gold';
    if (s.includes('—Å–µ—Ä') || s.includes('silver')) return 'silver';
    if (s.includes('–±—Ä–æ–Ω')|| s.includes('bronze')) return 'bronze';
    return '';
  };
  const medalEmoji = (t)=> t==='gold'?'ü•á':t==='silver'?'ü•à':t==='bronze'?'ü•â':'';

  function powerOn(){
    if (signalOn) return;
    signalOn = true;
    batSignalEl.classList.add('show','on');
    batSignalEl.classList.remove('off');
    setTimeout(()=>batSignalEl.classList.remove('on'), 480);
  }
  function powerOff(){
    if (!signalOn) return;
    signalOn = false;
    batSignalEl.classList.add('off');
    setTimeout(()=>{ batSignalEl.classList.remove('off','show'); }, 480);
  }

  async function fetchCSV(){
    try{
      const res = await fetch(CSV_URL + '&_=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      const parsed = Papa.parse(text, { skipEmptyLines: "greedy" });
      render(parsed.data);
      updatedEl.textContent = '–í—Ä–µ–º—è: ' + new Date().toLocaleTimeString();
    }catch(e){
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV:', e);
    }
  }

  function render(rows){
    if(!rows || rows.length===0){
      gridEl.innerHTML='';
      powerOff();
      return;
    }

    const header = rows[0].map(h => (h||'').toString().trim().toLowerCase());
    const hasHdr = header.some(h =>
      h.includes('—Ñ–∏–æ')||h.includes('name')||
      h.includes('–∏—Ç–æ–≥–æ')||h.includes('score')||
      h.includes('–º–µ–¥–∞–ª')||h.includes('medal')||
      h.includes('–∫–ª–∞—Å—Å')||h.includes('class')
    );
    const body = rows.slice(hasHdr?1:0);

    let idxName  = hasHdr ? header.findIndex(h=>h.includes('—Ñ–∏–æ')||h.includes('name'))   : 0;
    let idxScore = hasHdr ? header.findIndex(h=>h.includes('–∏—Ç–æ–≥–æ')||h.includes('score')) : 1;
    let idxMedal = hasHdr ? header.findIndex(h=>h.includes('–º–µ–¥–∞–ª')||h.includes('medal')) : 2;
    let idxClass = hasHdr ? header.findIndex(h=>h.includes('–∫–ª–∞—Å—Å')||h.includes('class')) : 3;
    if(idxName<0) idxName=0; if(idxScore<0) idxScore=1; if(idxMedal<0) idxMedal=2; if(idxClass<0) idxClass=3;

    const data = body.map(r=>{
      const name  = (r[idxName]  ?? '').toString().trim();
      const score = parseFloat((r[idxScore] ?? '0').toString().replace(',','.')) || 0;
      const medal = (r[idxMedal] ?? '').toString().trim();
      const klass = (r[idxClass] ?? '').toString().trim();
      return { name, score: Math.round(score), medal, klass };
    }).filter(r=>r.name);

    data.sort((a,b)=>{
      const ma = medalType(a.medal), mb = medalType(b.medal);
      const byM = (medalOrder[ma]??3)-(medalOrder[mb]??3); if(byM) return byM;
      const byS = (b.score||0)-(a.score||0);               if(byS) return byS;
      return a.name.localeCompare(b.name,'ru');
    });

    /* –ü—Ä–∞–≤–∏–ª–æ –≤–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–∂–µ–∫—Ç–æ—Ä–∞: –≤–∫–ª—é—á–∞–µ–º, –µ—Å–ª–∏ –ª–∏–¥–µ—Ä ‚Äî –∑–æ–ª–æ—Ç–æ */
    const topMedal = medalType(data[0]?.medal);
    if (topMedal === 'gold') powerOn(); else powerOff();

    gridEl.innerHTML='';
    data.forEach((row,i)=>{
      const t = medalType(row.medal), e = medalEmoji(t);
      const el = document.createElement('div'); el.className='tile';
      el.innerHTML = `
        <div class="left">
          <div class="rank">${i+1}</div>
          <div>
            <div class="name">${e?e+' ':''}${row.name}</div>
            ${row.klass ? `<div class="class">–ö–ª–∞—Å—Å: ${row.klass}</div>` : ""}
          </div>
        </div>
        <div class="right">
          ${e?`<div class="medal">${e}</div>`:''}
          <div class="score">${row.score}</div>
        </div>`;
      gridEl.appendChild(el);
    });
  }

  fetchCSV();
  setInterval(fetchCSV, REFRESH_MS);
</script>
</body>
</html>
